---
title: "Project_Template_shared.Rmd"
author: "Cheney Gardner and Yingfan Zeng"
date: "4/22/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if(!require(pacman)) install.packages("pacman")
pacman::p_load(tidyverse, dplyr, lubridate, rvest, dataRetrieval, sf, leaft, ggplot2, RColorBrewer, shiny, measurements, htmlwidgets, tinytex)

#update.packages(ask = FALSE, checkBuilt = TRUE)
#tinytex::tlmgr_update()
#tinytex::reinstall_tinytex()

gage.data.nc <- read.csv("./Data/Processed/gage_data_dam_new.csv")
falls.lake <- read.csv("./Data/Processed/falls_lake.csv")
huc8_sf <-  st_read("./Data/Raw/spatial_nc/NCHUC8.shp")
dam.data.nc <- read.csv("./Data/Raw/ARDamRemovalList_Figshare_Feb2021.csv") %>% filter(State == "NC") %>% select(Dam_Name:State) %>% na.omit()
counties_sf <-  st_read("./Data/Raw/spatial_nc/cb_2018_us_county_20m.shp") %>% filter(STATEFP == 37)
```

*Rationale and Research Questions:*

According to the Army Corps of Engineersâ€™ National Inventory of Dams, North Carolina has 3191 dams, including the Falls Lake Dam. The Falls Lake Dam, which TK, was completed in 1981 to manage the flow of the Neuse River.
 
Flood control dams remove high flows but can have anthropogenic impacts on the ecological needs of many aquatic species. For example, if a fish species has evolved to be triggered to spawn by high flows, a flood control dam may reduce future reproduction.
 
Over the past three decades a series of smaller dams downstream on the Neuse have been removed, and the Neuse River now flows freely from Falls Lake to the Pamlico Sound for the first time in 100 years.
 
Research has shown that the removal of these downstream dams has positive ecological effects. In 2019 shad began migrating all the way to Raleigh for the **first time** since the 18th century.
 
It is thought that the migration was potentially triggered by changes in the river flow as larger flows reduced salinity in estuaries and triggered the fish to migrate upstream.

- We wanted to determine if there was a change in discharge before and after the construction of the Falls Lake Dam, which is useful information for ecologists studying the impact of dams on habitat.

- We also wanted to plot the history of dam removals in North Carolina, as well as create an interactive map to allow users to find information about the downstream dams removed on the Neuse River and others around the state. This database includes 1,775 entries dating back to 1912.

*Dataset Information*

To evaluate the change in discharge before and after the construction of the Falls Lake Dam, we used daily mean discharge data from 4 gages on the Neuse River that we downloaded from the USGS National Water Information System. The date ranges are based on the dates in which the gage information is available, for example daily mean discharge data is available from Gage #02087183 from 1970 to 2020.

Falls Lake 02087183 (1970-2020)
Clayton 02087500 (1927-2020)
Goldsboro 02089000 (1930-2020)
Kinston 02089500 (1930-2020)

The Falls Lake Dam has recieved increased interest since the removal of downstream dams, most recently the Milburnie Dam in 2017. To visualize the downstream dams removed on the Neuse River and others around the state, we used categorical and geographic data from the American Rivers Dam Removal Database.

*Exploratory Analysis:*
The four gage sites, as well as the Falls Lake Dam, were mapped to provide spatial context. Using Leaflet, we were also able to include the USGS Station, County and HUC of the Gage station when the user interacted with the pop-up. The Gage Stations and Fall Lake Dam were overlaid on the HUC shapefile. WHY?

```{r gage location map, echo = FALSE}
gage.data.nc.dec <- gage.data.nc %>%
  select(USGS.Station, County, HUC, Latitude.dec, Longitude.dec) 
 
gage.data.nc.sf <- st_as_sf(gage.data.nc.dec,
                             coords = c('Longitude.dec','Latitude.dec'),
                             crs=4326)

falls.lake.dam.sf <- st_as_sf(falls.lake, 
                              coords =c("Longitude","Latitude"), 
                              crs = 4326)

tag.map.title <- tags$style(HTML("
  .leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 50%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    font-size: 12px;
  }
"))

title.gage <- tags$div(
  tag.map.title, HTML("Gage Stations overlaid on 8-Digit Subbasins, North Carolina (2021)")
)

pal2 <- colorNumeric(
    palette = 'Dark2',
  domain = huc8_sf$ACRES)

huc.gage.map <- leaflet() %>% 
  addProviderTiles("CartoDB.Positron") %>%  
  addPolygons(data = huc8_sf, 
              color = ~pal2(huc8_sf$ACRES), 
              weight = 1, 
              smoothFactor = 0.5,   
              opacity = 1.0,
              fillOpacity = 0.5) %>% 
    addMarkers(data = gage.data.nc.sf,
               popup = paste("USGS Station:", gage.data.nc.sf$USGS.Station, "<br>","County:", gage.data.nc.sf$County, "<br>","HUC:", gage.data.nc.sf$HUC)) %>%
  addCircleMarkers(data = falls.lake.dam.sf, fillOpacity = 0.5,color="black", popup = paste("Falls Lake Dam:", falls.lake$Constructed, "<br>")) %>%
  addLegend("bottomlef", pal = pal2, values = huc8_sf$ACRES,
    title = "HUC 8 Subbasins by area (acres)",
    opacity = 0.75
  ) %>%
  addControl(title.gage, position = "topleft", className="map-title")

huc.gage.map
saveWidget(huc.gage.map, file = "huc.gage.map.html")
```

To visualize the downstream dams removed on the Neuse River and others around the state, we wrangled American Rivers Dam Removal Database to only include information from North Carolina. Then 

```{r dam removal map, echo=FALSE}
dam.data.nc.sf <- st_as_sf(x = dam.data.nc, coords = c('Longitude','Latitude'), crs=4326)

title.dam <- tags$div(
  tag.map.title, HTML("Dam Removals (1988-2021) overlaid on Counties, North Carolina")
)

dam.map.with.county  <- leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data=counties_sf, 
              color = "green",
              weight = 1, 
              smoothFactor = 0.25,   
              opacity = .50, 
              fillOpacity = 0.5) %>%
  addMarkers(data=dam.data.nc.sf, 
                    popup = paste("Dam Name:", dam.data.nc.sf$Dam_Name, "<br>", "Year Removed:", dam.data.nc.sf$Year_Removed, "<br>", "River Restored:", dam.data.nc.sf$River)) %>%
  addCircleMarkers(data = falls.lake.dam.sf, fillOpacity = 0.5,color="black", popup = paste("Falls Lake Dam:", falls.lake$Constructed, "<br>")) %>%
  addControl(title.dam, position = "topleft", className="map-title")

dam.map.with.county
#saveWidget(dam.map.with.county, file = "dam.map.with.county.html")
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
